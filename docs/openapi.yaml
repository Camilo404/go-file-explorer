openapi: 3.0.3
info:
  title: Go File Explorer API
  version: 1.0.0
  description: |
    REST API para exploración y gestión de archivos con autenticación JWT, roles y operaciones asíncronas.

    Roles:
    - viewer: lectura
    - editor: lectura + operaciones de escritura
    - admin: todo + auditoría + registro de usuarios
servers:
  - url: http://localhost:8080
    description: Local

tags:
  - name: Health
  - name: Auth
  - name: Users
  - name: Explorer
  - name: Files
  - name: Operations
  - name: Trash
  - name: Search
  - name: Audit
  - name: Jobs
  - name: Storage
  - name: Shares

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: ok

  /api/v1/auth/login:
    post:
      tags: [Auth]
      summary: Login de usuario
      description: "Roles permitidos: viewer, editor, admin"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Tokens emitidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPairResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/auth/register:
    post:
      tags: [Auth]
      summary: Registrar usuario
      description: "Rol requerido: admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Usuario creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/AlreadyExistsError'

  /api/v1/auth/refresh:
    post:
      tags: [Auth]
      summary: Refrescar tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Nuevo par de tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPairResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/auth/logout:
    post:
      tags: [Auth]
      summary: Logout
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Logout exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BooleanActionResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/auth/me:
    get:
      tags: [Auth]
      summary: Perfil autenticado
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Usuario autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/files:
    get:
      tags: [Explorer]
      summary: Listado de directorio
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          schema: { type: string, example: / }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - in: query
          name: sort
          schema: { type: string, enum: [name, size, modified_at, type], default: name }
        - in: query
          name: order
          schema: { type: string, enum: [asc, desc], default: asc }
      responses:
        '200':
          description: Listado paginado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectoryListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

    delete:
      tags: [Operations]
      summary: Soft-delete de rutas
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRequest'
      responses:
        '200':
          description: Resultado por ruta
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/tree:
    get:
      tags: [Explorer]
      summary: Árbol de directorios (lazy load)
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          schema: { type: string, default: / }
        - in: query
          name: depth
          schema: { type: integer, minimum: 1, maximum: 3, default: 1 }
        - in: query
          name: include_files
          schema: { type: boolean, default: false }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 500, default: 200 }
      responses:
        '200':
          description: Nodos del árbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TreeResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/directories:
    post:
      tags: [Explorer]
      summary: Crear directorio
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDirectoryRequest'
      responses:
        '201':
          description: Directorio creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectoryCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/AlreadyExistsError'

  /api/v1/files/upload:
    post:
      tags: [Files]
      summary: Subir archivos
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: conflict_policy
          schema: { type: string, enum: [overwrite, rename, skip], default: rename }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                path:
                  type: string
                  example: /uploads
                conflict_policy:
                  type: string
                  enum: [overwrite, rename, skip]
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Resultado de uploads
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '413':
          $ref: '#/components/responses/PayloadTooLargeError'
        '415':
          $ref: '#/components/responses/UnsupportedTypeError'

  /api/v1/files/download:
    get:
      tags: [Files]
      summary: Descargar archivo o ZIP de directorio
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          required: true
          schema: { type: string }
        - in: query
          name: archive
          schema: { type: boolean, default: false }
      responses:
        '200':
          description: Archivo/zip stream
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            application/zip:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/files/preview:
    get:
      tags: [Files]
      summary: Preview inline de archivo
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Contenido inline
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/files/thumbnail:
    get:
      tags: [Files]
      summary: Obtener thumbnail JPEG
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          required: true
          schema: { type: string }
        - in: query
          name: size
          schema: { type: integer, minimum: 32, maximum: 2048, default: 256 }
      responses:
        '200':
          description: Thumbnail JPEG
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '204':
          description: Tipo de archivo no soportado para thumbnail
        '415':
          $ref: '#/components/responses/UnsupportedTypeError'

  /api/v1/files/info:
    get:
      tags: [Files]
      summary: Metadata de archivo/directorio
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, enum: [true] }
                  data: { $ref: '#/components/schemas/FileItem' }
                required: [success, data]
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/files/rename:
    put:
      tags: [Operations]
      summary: Renombrar archivo/directorio
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenameRequest'
      responses:
        '200':
          description: Renombrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenameResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/AlreadyExistsError'

  /api/v1/files/move:
    put:
      tags: [Operations]
      summary: Mover archivos/directorios
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MoveRequest'
      responses:
        '200':
          description: Resultado por item
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoveResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/files/copy:
    post:
      tags: [Operations]
      summary: Copiar archivos/directorios
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MoveRequest'
      responses:
        '200':
          description: Resultado por item
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CopyResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/files/restore:
    post:
      tags: [Operations]
      summary: Restaurar rutas desde trash
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestoreRequest'
      responses:
        '200':
          description: Restauración por item
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestoreResponseEnvelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/search:
    get:
      tags: [Search]
      summary: Buscar archivos/directorios
      description: "Rol requerido: viewer/editor/admin. Se requiere al menos uno de: q, type o ext"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: path
          schema: { type: string, default: / }
        - in: query
          name: type
          schema: { type: string, enum: [file, dir] }
        - in: query
          name: ext
          schema: { type: string, example: .pdf }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
      responses:
        '200':
          description: Resultados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/audit:
    get:
      tags: [Audit]
      summary: Consultar auditoría
      description: "Rol requerido: admin"
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: action
          schema: { type: string }
        - in: query
          name: actor_id
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string, enum: [success, failed] }
        - in: query
          name: path
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
      responses:
        '200':
          description: Eventos de auditoría
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/jobs/operations:
    post:
      tags: [Jobs]
      summary: Crear job asíncrono
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobOperationRequest'
      responses:
        '202':
          description: Job aceptado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/jobs/{job_id}:
    get:
      tags: [Jobs]
      summary: Estado de job
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: job_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Estado del job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/jobs/{job_id}/items:
    get:
      tags: [Jobs]
      summary: Items de resultado por job
      description: "Rol requerido: editor/admin"
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: job_id
          required: true
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
      responses:
        '200':
          description: Items del job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobItemsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/auth/change-password:
    put:
      tags: [Auth]
      summary: Cambiar contraseña del usuario autenticado
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Contraseña actualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BooleanActionResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/users:
    get:
      tags: [Users]
      summary: Listar todos los usuarios
      description: "Rol requerido: admin"
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/users/{id}:
    get:
      tags: [Users]
      summary: Obtener usuario por ID
      description: "Rol requerido: admin"
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Datos del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    put:
      tags: [Users]
      summary: Actualizar rol de usuario
      description: "Rol requerido: admin"
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Usuario actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    delete:
      tags: [Users]
      summary: Eliminar usuario
      description: "Rol requerido: admin. No permite auto-eliminación."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Usuario eliminado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletedActionResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/trash/{id}:
    delete:
      tags: [Trash]
      summary: Eliminación permanente de un elemento de la papelera
      description: "Rol requerido: editor/admin. Elimina permanentemente un elemento de la papelera por su ID."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Elemento eliminado permanentemente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletedActionResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/trash:
    get:
      tags: [Trash]
      summary: Listar elementos en la papelera
      description: "Rol requerido: editor/admin. Lista todos los elementos en la papelera."
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: include_restored
          schema: { type: boolean, default: false }
          description: Incluir elementos ya restaurados
      responses:
        '200':
          description: Lista de elementos en la papelera
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrashListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
    delete:
      tags: [Trash]
      summary: Vaciar toda la papelera
      description: "Rol requerido: editor/admin. Elimina permanentemente todos los elementos de la papelera."
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Papelera vaciada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmptyTrashResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/v1/storage/stats:
    get:
      tags: [Storage]
      summary: Estadísticas de almacenamiento
      description: "Rol requerido: viewer/editor/admin"
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Estadísticas de uso de almacenamiento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageStatsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/jobs/{job_id}/stream:
    get:
      tags: [Jobs]
      summary: Stream de progreso de job (SSE)
      description: |
        Rol requerido: editor/admin.
        Endpoint Server-Sent Events (SSE) que emite actualizaciones de progreso en tiempo real para un job.
        Cada evento contiene un JSON con job_id, status, progress, processed_items, total_items, success_items y failed_items.
        El stream se cierra automáticamente cuando el job finaliza.
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: job_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Stream de eventos SSE
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Cada línea tiene formato `data: {json}\n\n` donde json es un objeto JobUpdate.
                example: |
                  data: {"job_id":"abc-123","status":"running","progress":50,"processed_items":5,"total_items":10,"success_items":5,"failed_items":0}
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/shares:
    post:
      tags: [Shares]
      summary: Crear enlace de compartición
      description: "Rol requerido: editor/admin. Genera un enlace público temporal para compartir un archivo o directorio."
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateShareRequest'
      responses:
        '201':
          description: Enlace de compartición creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareRecordResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    get:
      tags: [Shares]
      summary: Listar enlaces de compartición del usuario
      description: "Rol requerido: viewer/editor/admin. Devuelve los enlaces activos (no expirados) creados por el usuario autenticado."
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de shares activos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/shares/{id}:
    delete:
      tags: [Shares]
      summary: Revocar enlace de compartición
      description: "Rol requerido: editor/admin. Elimina un enlace de compartición creado por el usuario."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Enlace revocado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokedActionResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/v1/public/shares/{token}:
    get:
      tags: [Shares]
      summary: Descargar recurso compartido (público)
      description: |
        No requiere autenticación. Descarga el archivo o directorio (como ZIP) asociado al token de compartición.
        Devuelve 410 Gone si el enlace ha expirado.
      parameters:
        - in: path
          name: token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Archivo o ZIP descargado
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            application/zip:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '410':
          description: Enlace expirado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorEnvelope' }

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequestError:
      description: Solicitud inválida
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            invalidBody: { $ref: '#/components/examples/BadRequest' }
    UnauthorizedError:
      description: Token inválido o ausente
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            unauthorized: { $ref: '#/components/examples/Unauthorized' }
    ForbiddenError:
      description: Rol insuficiente
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            forbidden: { $ref: '#/components/examples/Forbidden' }
    NotFoundError:
      description: Recurso no encontrado
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            notFound: { $ref: '#/components/examples/NotFound' }
    AlreadyExistsError:
      description: Recurso ya existente
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            conflict: { $ref: '#/components/examples/AlreadyExists' }
    PayloadTooLargeError:
      description: Payload demasiado grande
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            payloadTooLarge: { $ref: '#/components/examples/PayloadTooLarge' }
    UnsupportedTypeError:
      description: MIME no permitido/no soportado
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorEnvelope' }
          examples:
            unsupportedType: { $ref: '#/components/examples/UnsupportedType' }

  examples:
    BadRequest:
      value:
        success: false
        error:
          code: BAD_REQUEST
          message: invalid JSON body
    Unauthorized:
      value:
        success: false
        error:
          code: UNAUTHORIZED
          message: invalid or expired token
    Forbidden:
      value:
        success: false
        error:
          code: FORBIDDEN
          message: insufficient permissions
    NotFound:
      value:
        success: false
        error:
          code: NOT_FOUND
          message: path not found
    AlreadyExists:
      value:
        success: false
        error:
          code: ALREADY_EXISTS
          message: target path already exists
    PayloadTooLarge:
      value:
        success: false
        error:
          code: PAYLOAD_TOO_LARGE
          message: request body too large
    UnsupportedType:
      value:
        success: false
        error:
          code: UNSUPPORTED_TYPE
          message: file MIME type is not allowed
    RateLimited:
      value:
        success: false
        error:
          code: RATE_LIMITED
          message: Too many requests

  schemas:
    APIError:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        details: { type: string }
      required: [code, message]

    Meta:
      type: object
      properties:
        page: { type: integer }
        limit: { type: integer }
        total: { type: integer }
        total_pages: { type: integer }
      required: [page, limit, total, total_pages]

    ErrorEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [false] }
        error: { $ref: '#/components/schemas/APIError' }
      required: [success, error]

    AuthUser:
      type: object
      properties:
        id: { type: string }
        username: { type: string }
        role: { type: string, enum: [viewer, editor, admin] }
      required: [id, username, role]

    TokenPair:
      type: object
      properties:
        access_token: { type: string }
        refresh_token: { type: string }
        token_type: { type: string, example: Bearer }
        expires_in: { type: integer }
        user: { $ref: '#/components/schemas/AuthUser' }
      required: [access_token, refresh_token, token_type, expires_in, user]

    TokenPairResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/TokenPair' }
      required: [success, data]

    AuthUserResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/AuthUser' }
      required: [success, data]

    BooleanActionResponse:
      type: object
      description: Respuesta genérica con un campo booleano de acción
      properties:
        success: { type: boolean, enum: [true] }
        data:
          type: object
          properties:
            logged_out: { type: boolean }
            changed: { type: boolean }
      required: [success, data]

    LoginRequest:
      type: object
      properties:
        username: { type: string }
        password: { type: string }
      required: [username, password]

    RegisterRequest:
      type: object
      properties:
        username: { type: string }
        password: { type: string }
        role: { type: string, enum: [viewer, editor, admin] }
      required: [username, password]

    RefreshRequest:
      type: object
      properties:
        refresh_token: { type: string }
      required: [refresh_token]

    FileItem:
      type: object
      properties:
        name: { type: string }
        path: { type: string }
        type: { type: string, enum: [file, directory] }
        size: { type: integer, format: int64 }
        size_human: { type: string }
        mime_type: { type: string }
        extension: { type: string }
        preview_url: { type: string }
        thumbnail_url: { type: string }
        is_image: { type: boolean }
        is_video: { type: boolean }
        modified_at: { type: string, format: date-time }
        created_at: { type: string, format: date-time }
        match_context: { type: string }
        permissions: { type: string }
        item_count: { type: integer }
      required: [name, path, type, size, modified_at, created_at, permissions]

    DirectoryListData:
      type: object
      properties:
        current_path: { type: string }
        parent_path: { type: string }
        items:
          type: array
          items: { $ref: '#/components/schemas/FileItem' }
      required: [current_path, parent_path, items]

    DirectoryListResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/DirectoryListData' }
        meta: { $ref: '#/components/schemas/Meta' }
      required: [success, data, meta]

    TreeNode:
      type: object
      properties:
        name: { type: string }
        path: { type: string }
        type: { type: string, enum: [file, directory] }
        has_children: { type: boolean }
        item_count: { type: integer }
        modified_at: { type: string, format: date-time }
        children:
          type: array
          items: { $ref: '#/components/schemas/TreeNode' }
      required: [name, path, type, has_children, modified_at]

    TreeData:
      type: object
      properties:
        path: { type: string }
        nodes:
          type: array
          items: { $ref: '#/components/schemas/TreeNode' }
      required: [path, nodes]

    TreeResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/TreeData' }
        meta: { $ref: '#/components/schemas/Meta' }
      required: [success, data, meta]

    CreateDirectoryRequest:
      type: object
      properties:
        path: { type: string }
        name: { type: string }
      required: [name]

    DirectoryCreateData:
      type: object
      properties:
        name: { type: string }
        path: { type: string }
        type: { type: string, example: directory }
        created_at: { type: string, format: date-time }
      required: [name, path, type, created_at]

    DirectoryCreateResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/DirectoryCreateData' }
      required: [success, data]

    UploadItem:
      type: object
      properties:
        name: { type: string }
        path: { type: string }
        size: { type: integer, format: int64 }
        mime_type: { type: string }
      required: [name, path, size, mime_type]

    UploadFailure:
      type: object
      properties:
        name: { type: string }
        reason: { type: string }
      required: [name, reason]

    UploadResponseData:
      type: object
      properties:
        uploaded:
          type: array
          items: { $ref: '#/components/schemas/UploadItem' }
        failed:
          type: array
          items: { $ref: '#/components/schemas/UploadFailure' }
      required: [uploaded, failed]

    UploadResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/UploadResponseData' }
      required: [success, data]

    RenameRequest:
      type: object
      properties:
        path: { type: string }
        new_name: { type: string }
      required: [path, new_name]

    RenameResponse:
      type: object
      properties:
        old_path: { type: string }
        new_path: { type: string }
        name: { type: string }
      required: [old_path, new_path, name]

    RenameResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/RenameResponse' }
      required: [success, data]

    MoveRequest:
      type: object
      properties:
        sources:
          type: array
          items: { type: string }
        destination: { type: string }
        conflict_policy: { type: string, enum: [overwrite, rename, skip], default: rename }
      required: [sources, destination]

    MoveCopyResult:
      type: object
      properties:
        from: { type: string }
        to: { type: string }
      required: [from, to]

    MoveCopyFailure:
      type: object
      properties:
        from: { type: string }
        reason: { type: string }
      required: [from, reason]

    MoveResponseData:
      type: object
      properties:
        moved:
          type: array
          items: { $ref: '#/components/schemas/MoveCopyResult' }
        failed:
          type: array
          items: { $ref: '#/components/schemas/MoveCopyFailure' }
      required: [moved, failed]

    MoveResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/MoveResponseData' }
      required: [success, data]

    CopyResponseData:
      type: object
      properties:
        copied:
          type: array
          items: { $ref: '#/components/schemas/MoveCopyResult' }
        failed:
          type: array
          items: { $ref: '#/components/schemas/MoveCopyFailure' }
      required: [copied, failed]

    CopyResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/CopyResponseData' }
      required: [success, data]

    DeleteRequest:
      type: object
      properties:
        paths:
          type: array
          items: { type: string }
      required: [paths]

    DeleteFailure:
      type: object
      properties:
        path: { type: string }
        reason: { type: string }
      required: [path, reason]

    DeleteResponseData:
      type: object
      properties:
        deleted:
          type: array
          items: { type: string }
        failed:
          type: array
          items: { $ref: '#/components/schemas/DeleteFailure' }
      required: [deleted, failed]

    DeleteResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/DeleteResponseData' }
      required: [success, data]

    RestoreRequest:
      type: object
      properties:
        paths:
          type: array
          items: { type: string }
      required: [paths]

    RestoreFailure:
      type: object
      properties:
        path: { type: string }
        reason: { type: string }
      required: [path, reason]

    RestoreResponseData:
      type: object
      properties:
        restored:
          type: array
          items: { type: string }
        failed:
          type: array
          items: { $ref: '#/components/schemas/RestoreFailure' }
      required: [restored, failed]

    RestoreResponseEnvelope:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/RestoreResponseData' }
      required: [success, data]

    SearchData:
      type: object
      properties:
        query: { type: string }
        items:
          type: array
          items: { $ref: '#/components/schemas/FileItem' }
      required: [query, items]

    SearchResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/SearchData' }
        meta: { $ref: '#/components/schemas/Meta' }
      required: [success, data, meta]

    AuditActor:
      type: object
      properties:
        user_id: { type: string }
        username: { type: string }
        role: { type: string }
        ip: { type: string }

    AuditEntry:
      type: object
      properties:
        action: { type: string }
        occurred_at: { type: string, format: date-time }
        actor: { $ref: '#/components/schemas/AuditActor' }
        status: { type: string }
        resource: { type: string }
        before: {}
        after: {}
        error: { type: string }
      required: [action, occurred_at, actor, status]

    AuditData:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/AuditEntry' }
      required: [items]

    AuditResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/AuditData' }
        meta: { $ref: '#/components/schemas/Meta' }
      required: [success, data, meta]

    JobOperationRequest:
      type: object
      properties:
        operation: { type: string, enum: [copy, move, delete] }
        sources:
          type: array
          items: { type: string }
        destination: { type: string }
        paths:
          type: array
          items: { type: string }
        conflict_policy: { type: string, enum: [overwrite, rename, skip], default: rename }
      required: [operation]

    JobItemResult:
      type: object
      properties:
        from: { type: string }
        to: { type: string }
        path: { type: string }
        status: { type: string, enum: [success, failed, skipped] }
        reason: { type: string }
      required: [status]

    JobData:
      type: object
      properties:
        job_id: { type: string }
        operation: { type: string }
        status: { type: string, enum: [queued, running, completed, partial, failed] }
        conflict_policy: { type: string }
        total_items: { type: integer }
        processed_items: { type: integer }
        success_items: { type: integer }
        failed_items: { type: integer }
        progress: { type: integer, minimum: 0, maximum: 100 }
        created_at: { type: string, format: date-time }
        started_at: { type: string, format: date-time }
        finished_at: { type: string, format: date-time }
      required:
        - job_id
        - operation
        - status
        - total_items
        - processed_items
        - success_items
        - failed_items
        - progress
        - created_at

    JobResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/JobData' }
      required: [success, data]

    JobItemsData:
      type: object
      properties:
        job_id: { type: string }
        items:
          type: array
          items: { $ref: '#/components/schemas/JobItemResult' }
      required: [job_id, items]

    JobItemsResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/JobItemsData' }
        meta: { $ref: '#/components/schemas/Meta' }
      required: [success, data, meta]

    ChangePasswordRequest:
      type: object
      properties:
        current_password: { type: string }
        new_password: { type: string }
      required: [current_password, new_password]

    UpdateUserRequest:
      type: object
      properties:
        role: { type: string, enum: [viewer, editor, admin] }
      required: [role]

    UserListData:
      type: object
      properties:
        users:
          type: array
          items: { $ref: '#/components/schemas/AuthUser' }
      required: [users]

    UserListResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/UserListData' }
      required: [success, data]

    DeletedActionResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data:
          type: object
          properties:
            deleted: { type: boolean }
      required: [success, data]

    EmptyTrashData:
      type: object
      properties:
        deleted_count: { type: integer }
      required: [deleted_count]

    EmptyTrashResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/EmptyTrashData' }
      required: [success, data]

    TrashRecord:
      type: object
      properties:
        id: { type: string }
        original_path: { type: string }
        trash_name: { type: string }
        deleted_at: { type: string, format: date-time }
        deleted_by: { $ref: '#/components/schemas/AuditActor' }
        restored_at: { type: string, format: date-time }
        restored_by: { $ref: '#/components/schemas/AuditActor' }
      required: [id, original_path, trash_name, deleted_at, deleted_by]

    TrashListResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: '#/components/schemas/TrashRecord' }
          required: [items]
      required: [success, data]

    StorageStats:
      type: object
      properties:
        total_size: { type: integer, format: int64 }
        total_size_human: { type: string }
        file_count: { type: integer }
        directory_count: { type: integer }
      required: [total_size, total_size_human, file_count, directory_count]

    StorageStatsResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/StorageStats' }
      required: [success, data]

    JobUpdate:
      type: object
      description: Evento SSE de progreso de job
      properties:
        job_id: { type: string }
        status: { type: string, enum: [queued, running, completed, partial, failed] }
        progress: { type: integer, minimum: 0, maximum: 100 }
        processed_items: { type: integer }
        total_items: { type: integer }
        success_items: { type: integer }
        failed_items: { type: integer }
      required: [job_id, status, progress, processed_items, total_items, success_items, failed_items]

    CreateShareRequest:
      type: object
      properties:
        path: { type: string }
        expires_in: { type: string, description: "Duración en formato Go (ej: 24h, 72h, 168h). Por defecto 24h.", example: "72h" }
      required: [path]

    ShareRecord:
      type: object
      properties:
        id: { type: string }
        token: { type: string }
        path: { type: string }
        created_by: { type: string }
        created_at: { type: string, format: date-time }
        expires_at: { type: string, format: date-time }
      required: [id, token, path, created_by, created_at, expires_at]

    ShareRecordResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/ShareRecord' }
      required: [success, data]

    ShareListData:
      type: object
      properties:
        shares:
          type: array
          items: { $ref: '#/components/schemas/ShareRecord' }
      required: [shares]

    ShareListResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data: { $ref: '#/components/schemas/ShareListData' }
      required: [success, data]

    RevokedActionResponse:
      type: object
      properties:
        success: { type: boolean, enum: [true] }
        data:
          type: object
          properties:
            revoked: { type: boolean }
      required: [success, data]

security:
  - BearerAuth: []
